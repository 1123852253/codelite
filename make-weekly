#!/bin/bash

# Keep the current folder
curdir=`pwd`

# Clear old installers
os_name=`uname -s`
upload_file="no"
build_php="no"
if [ "$1" == "--php-build" ] || [ "$2" == "--php-build" ] ; then
    build_php="yes"
fi

if [ "$1" == "--upload" ] || [ "$2" == "--upload" ] ; then
    upload_file="yes"
fi

# Clear old installers
os_name=`uname -s`
if [ ${os_name} == "Darwin" ]; then
    echo rm -f $curdir/build-release/codelite.app.tar.gz
    rm -f $curdir/build-release/codelite.app.tar.gz
    cpu_count=4
else
    cpu_count=`grep -c ^processor /proc/cpuinfo`
fi

echo "Platform     : ${os_name}"
echo "CPU count    : ${cpu_count}"
echo "Upload binary: ${upload_file}"
echo "PHP Build    : ${build_php}"

# Update our source tree
cd $curdir
echo "Pulling CodeLite changes..."
echo `pwd`
git pull --rebase 
if [ $? -ne 0 ]; then
    exit $?
fi

echo "Pulling wxCrafter changes..."
cd $curdir/wxcrafter
git pull --rebase
if [ $? -ne 0 ]; then
    exit $?
fi
cd $curdir

linux_build() {
    cd $curdir/$1 # cd to the build folder
    echo rm -fr *.deb
    rm -fr *.deb
    CMAKE_EXTRA_PARAMS=""
    if [ "${build_php}" == "yes" ]; then
        CMAKE_EXTRA_PARAMS="-DPHP_BUILD=1"
    fi
    PATH=.:$PATH cmake -DCMAKE_BUILD_TYPE=Release -DMAKE_DEB=1 -DCOPY_WX_LIBS=1 .. ${CMAKE_EXTRA_PARAMS}
    make -j${cpu_count} && make package
    if [ "${upload_file}" == "yes" ]; then
        deb_file=`ls -lt *.deb|awk '{print $9;}'|head -n 1`
        echo Uploading deb file ${deb_file}
        scp ${deb_file} root@codelite.org:/var/www/html/downloads/codelite/wip
    fi
    cd $curdir
}

# Build and upload
if [ ${os_name} == "Darwin" ]; then
    cd build-release
    cmake -DCMAKE_BUILD_TYPE=Release .. -DWITH_PCH=1
    make -j${cpu_count} && make install
    if [ "${upload_file}" == "yes" ]; then
        tar cvfz codelite.app.tar.gz codelite.app/*
        scp codelite.app.tar.gz root@codelite.org:/var/www/html/downloads/codelite/wip
    fi
else
    linux_build build-release-gtk3
    if [ "${build_php}" == "yes" ]; then
        linux_build build-release-php
    fi
fi
